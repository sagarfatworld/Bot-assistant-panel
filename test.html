<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bot Answer Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }
    #chatList {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
    }
    .chat-item {
      cursor: pointer;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .chat-item:hover {
      background-color: #f0f0f0;
    }
    #answer {
      margin-top: 20px;
      font-style: italic;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>Bot Answer Panel</h2>

  <div id="chatList">
    <!-- Chat IDs will be listed here -->
  </div>
  <div id="answer">
    <!-- Bot answer will appear here -->
  </div>

  <!-- LiveChat Agent App SDK -->
  <script src="https://cdn.livechatinc.com/agent-app-sdk/release/3.2.0/agent-app-sdk.min.js"></script>

  <script>
    const webhookUrl = "https://bot.flatworldsolutions.com/lcapi/webhook";
    const chatListDiv = document.getElementById("chatList");
    const answerDiv = document.getElementById("answer");

    // Step 1: Get logged-in agent's email and store it
    LiveChatWidget.on('ready', async () => {
      try {
        const identity = await LiveChatWidget.get('identity');
        const agentEmail = identity?.email || 'Unknown';
        localStorage.setItem('livechat_email', agentEmail);

        // Optional: Display it in header
        const header = document.querySelector('h2');
        if (header) {
          header.innerText += ` (${agentEmail})`;
        }

        console.log("Agent email stored:", agentEmail);
      } catch (err) {
        console.error("Failed to get agent email:", err);
      }
    });

    // Step 2: Load active chats from localStorage
    function loadActiveChats() {
      const activeChats = JSON.parse(localStorage.getItem("livechat_active_chats") || "[]");

      chatListDiv.innerHTML = ""; // Clear current list

      if (activeChats.length === 0) {
        chatListDiv.innerHTML = "<p>No active chats found.</p>";
        return;
      }

      activeChats.forEach((chat) => {
        const div = document.createElement("div");
        div.className = "chat-item";
        div.textContent = chat.id;
        div.onclick = () => fetchBotAnswer(chat.id);
        chatListDiv.appendChild(div);
      });
    }

    // Step 3: Fetch bot answer for selected chat
    async function fetchBotAnswer(chatId) {
      const messages = JSON.parse(localStorage.getItem("livechat_messages") || "{}");
      const chatMessages = messages[chatId] || [];

      // Get latest message from visitor
      const visitorMsg = chatMessages.reverse().find(msg => msg.author_type === "visitor");

      if (!visitorMsg) {
        answerDiv.innerHTML = "<p>No visitor message found in this chat.</p>";
        return;
      }

      const question = visitorMsg.text;
      const agentEmail = localStorage.getItem("livechat_email") || "";

      try {
        const response = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: agentEmail,
            chat_id: chatId,
            question: question,
          }),
        });

        const data = await response.json();
        answerDiv.innerHTML = `<strong>Bot:</strong> ${data.answer || 'No answer returned.'}`;
      } catch (err) {
        console.error("Error fetching bot answer:", err);
        answerDiv.innerHTML = "<p>Failed to get bot answer.</p>";
      }
    }

    loadActiveChats();
  </script>
</body>
</html>
