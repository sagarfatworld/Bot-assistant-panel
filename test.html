<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Bot Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/@livechat/agent-app-sdk@1.6.3/dist/agentapp.umd.min.js"></script>
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self' https://my.livechat.com">
    <!-- Your existing styles remain the same -->
</head>
<body>
    <div class="container">
        <div id="agent-info">Initializing...</div>
        <h2>ðŸ¤– Bot Assistant Panel</h2>
        <div id="chatButtons" class="chat-buttons"></div>
        <div id="conversation" class="conversation"></div>
        <div class="footer">Powered by Bot@Work</div>
    </div>

    <script>
        let agentId = '';
        let userEmail = '';
        let currentChatId = null;
        let lastMessageCount = 0;

        // Initialize LiveChat widget and set up event listeners
        LiveChat.createDetailsWidget().then(function(widget) {
            console.log('Widget created successfully');

            widget.on('ticket_info', function(ticketInfo) {
                console.log('Ticket info received:', ticketInfo);

                if (ticketInfo && ticketInfo.assignedAgent) {
                    const agent = ticketInfo.assignedAgent;
                    
                    // Store agent information
                    agentId = agent.id;
                    userEmail = agent.email;

                    // Display agent info
                    document.getElementById('agent-info').innerHTML = 
                        `Logged in as: ${agent.name || agent.email} (${agent.id})`;

                    // Login to backend
                    loginToBackend(agent)
                        .then(() => {
                            console.log('Backend login successful');
                            // Start fetching chats
                            fetchChats();
                            setInterval(fetchChats, 5000);
                            setInterval(updateCurrentChat, 2000);
                        })
                        .catch(error => {
                            console.error('Backend login failed:', error);
                            document.getElementById('agent-info').innerText = 
                                'Login error: ' + error.message;
                        });
                }
            });
        }).catch(error => {
            console.error('Failed to create widget:', error);
            document.getElementById('agent-info').innerText = 
                'Widget initialization error: ' + error.message;
        });

        async function loginToBackend(agent) {
            try {
                const response = await fetch('https://testing-app-rb2j.onrender.com/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agentUserId: agent.id,
                        agentEmail: agent.email
                    })
                });

                if (!response.ok) {
                    throw new Error('Backend login failed');
                }
            } catch (error) {
                throw new Error(`Backend login error: ${error.message}`);
            }
        }

        async function fetchChats() {
            try {
                if (!agentId) {
                    console.log('No agent ID available');
                    return;
                }

                const response = await fetch(`https://testing-app-rb2j.onrender.com/livechat/chats/${agentId}`);
                const chats = await response.json();
                
                const buttonContainer = document.getElementById('chatButtons');
                buttonContainer.innerHTML = '';

                if (chats.length > 1) {
                    chats.forEach(chat => {
                        const button = document.createElement('button');
                        button.className = 'chat-button';
                        button.textContent = chat.chatId;
                        button.onclick = () => showChat(chat.chatId);
                        buttonContainer.appendChild(button);
                    });
                } else if (chats.length === 1) {
                    showChat(chats[0].chatId);
                }
            } catch (error) {
                console.error('Error fetching chats:', error);
            }
        }

        // Your existing showChat, updateCurrentChat, and appendQA functions remain the same
    </script>
</body>
</html>
